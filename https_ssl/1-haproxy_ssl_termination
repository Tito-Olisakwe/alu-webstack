#!/usr/bin/env bash
# Bash script that configures HAproxy

# Obtain a certificate for your domain name
sudo certbot certonly --standalone -d titoparisolisakwe.tech -d www.titoparisolisakwe.tech

# Concatenate the certificate and private key into a single PEM file
sudo cat /etc/letsencrypt/live/titoparisolisakwe.tech/fullchain.pem /etc/letsencrypt/live/titoparisolisakwe.tech/privkey.pem | sudo tee /etc/haproxy/haproxy.pem

# Update HAproxy configuration file
sudo bash -c 'cat > /etc/haproxy/haproxy.cfg' << EOF
frontend www-https
    bind *:443 ssl crt /etc/haproxy/haproxy.pem
    mode http
    default_backend www-backend

backend www-backend
    mode http
    balance roundrobin
    server webserver1 107.20.111.173:80 check
EOF

# Restart HAproxy to apply the new configuration
sudo service haproxy restart
